---
title: "Web scraping MLB Data"
format:
  html: default
editor_options: 
  chunk_output_type: console
---
```{r}
#| include: FALSE

library(stringr)
library(rvest)
library(httr)
library(tidyverse)
```

```{r}
get_mvp_by_year <- function(year, hasNL) {
  
  url <- str_c("https://www.baseball-reference.com/awards/awards_", year, ".shtml")
  
  print(url)
  
  robotstxt::paths_allowed(url)
  
  mlb_html <- read_html(url)
  
  tables <- mlb_html |>
    html_nodes(css = "table") |>
    html_table()
  
  mvp_col_names <- c("Rank", "Name", "Team", "Vote_PTS", "First_Place", "Share", "WAR", "BS_G", "AB", "R", "BS_H", "BS_HR", "RBI", "SB", "BS_BB", "BA", "OBP", "SLG", "OPS", "W", "L", "ERA", "WHIP", "PS_G", "GS", "SV", "IP", "PS_H", "PS_HR", "PS_BB","SO")
  
  mvp_voting_al <- tables[[1]]
  
  mvp_voting_al <- mvp_voting_al |>
    setNames(mvp_col_names) |>
    select(-Rank) |>
    slice(2) |>
    mutate(Year = year,
           Lg = "AL",
           Share = str_replace(Share, "%", ""),
           Share = as.numeric(Share),
           across(c("Vote_PTS", "First_Place", "WAR", "BS_G", "AB", "R", "BS_H", "BS_HR", "RBI", "SB", "BS_BB", "BA", "OBP", "SLG", "OPS", "W", "L", "ERA", "WHIP", "PS_G", "GS", "SV", "IP", "PS_H", "PS_HR", "PS_BB", "SO"), ~as.numeric(.))) |>
    select("Year","Name", "Lg", "Team", "Vote_PTS", "First_Place", "WAR", "BS_G", "AB", "R", "BS_H", "BS_HR", "RBI", "SB", "BS_BB", "BA", "OBP", "SLG", "OPS", "W", "L", "ERA", "WHIP", "PS_G", "GS", "SV", "IP", "PS_H", "PS_HR", "PS_BB", "SO")
  
  if(hasNL) {
    mvp_voting_nl <- tables[[2]]
    
    mvp_voting_nl <- mvp_voting_nl |>
    setNames(mvp_col_names) |>
    select(-Rank) |>
    slice(2) |>
    mutate(Year = year,
           Lg = "NL",
           Share = str_replace(Share, "%", ""),
           Share = as.numeric(Share),
           across(c("Vote_PTS", "First_Place", "WAR", "BS_G", "AB", "R", "BS_H", "BS_HR", "RBI", "SB", "BS_BB", "BA", "OBP", "SLG", "OPS", "W", "L", "ERA", "WHIP", "PS_G", "GS", "SV", "IP", "PS_H", "PS_HR", "PS_BB", "SO"), ~as.numeric(.))) |>
    select("Year","Name", "Lg", "Team", "Vote_PTS", "First_Place", "WAR", "BS_G", "AB", "R", "BS_H", "BS_HR", "RBI", "SB", "BS_BB", "BA", "OBP", "SLG", "OPS", "W", "L", "ERA", "WHIP", "PS_G", "GS", "SV", "IP", "PS_H", "PS_HR", "PS_BB", "SO")
  
  
  mvp_voting <- mvp_voting_al |>
    add_row(mvp_voting_nl)
  
  mvp_voting
  } else{
    mvp_voting_al
  }
}
```

```{r}
mvp_voting_2023 <- get_mvp_by_year(2023)

mvp_voting_full <- mvp_voting_2023

for (year in c(1911:1914, 1922:2023)) {
  
  if(year == 1922 | year == 1923) {
    mvp_voting_full <- mvp_voting_full |>
      bind_rows(get_mvp_by_year(year, FALSE))
  } else {
    mvp_voting_full <- mvp_voting_full |>
      bind_rows(get_mvp_by_year(year, TRUE))
  }
  
  # Need to wait: Error Code 429 - Too many requests
  Sys.sleep(5)
}

mvp_voting_full <- mvp_voting_full |>
  distinct(Year, Lg, .keep_all = TRUE) |>
  arrange(Year)

write.csv(mvp_voting_full, "./data/mvp_voting.csv")
```


```{r}
mvp_voting_full <- read_csv("./data/mvp_voting.csv")
```



```{r}
MVP_DAT<- read_html("https://www.baseball-reference.com/awards/mvp.shtml") |>
  html_nodes("table") %>%
  .[[1]] %>%  
  html_table()

CYA_DAT<- read_html("https://www.baseball-reference.com/awards/cya.shtml") |>
  html_nodes("table") %>%
  .[[1]] %>%  
  html_table()

ROY_DAT<- read_html("https://www.baseball-reference.com/awards/roy.shtml") |>
  html_nodes("table") %>%
  .[[1]] %>%  
  html_table()


colnames(MVP_DAT) <- as.character(MVP_DAT[1,])
colnames(ROY_DAT) <- as.character(ROY_DAT[1,])
MVP_DAT<- MVP_DAT|>
  filter(Year!= "Year")|>
  filter(Year >= 1911)|>
  mutate(Pitcher = ifelse(IP > 10, TRUE, FALSE),Year = as.numeric(Year), across(.cols = WAR:SO, .fns = ~as.numeric(as.character(.))) )
MVP_DAT

ROY_DAT<- ROY_DAT|>
   filter(Year!= "Year")|>
  filter(Year >= 1911)|>
  mutate(Pitcher = ifelse(IP > 10, TRUE, FALSE),Year = as.numeric(Year), across(.cols = WAR:SO, .fns = ~as.numeric(as.character(.))) )

ROY_DAT


CYA_DAT<- CYA_DAT|>
  mutate(Year= as.numeric(Year), across(.cols = WAR:SO, .fns = ~as.numeric(as.character(.))))|>
  filter(Year>1900)
  

CYA_DAT
```



```{r}
mlb_mvp <- mvp_voting_full |>
  select(-WAR, -RBI, -SB, -BA, -OBP, -SLG, -W, -L, -SV, -IP, -ERA, -SO) |>
  inner_join(MVP_DAT, by = join_by(Name, Year, Lg)) |>
  select(-Voting, -Tm, -...1)

write.csv(mlb_mvp, "./data/mlb_mvp.csv")
```



